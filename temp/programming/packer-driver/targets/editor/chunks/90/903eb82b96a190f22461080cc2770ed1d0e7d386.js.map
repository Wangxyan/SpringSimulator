{"version":3,"sources":["file:///D:/CODE/cocos_workspace/%E8%83%8C%E5%8C%85%E8%8B%B1%E9%9B%84/assets/Scripts/Frame/Configuration.ts"],"names":["Configuration","sys","Constants","Util","_jsonData","_markSave","instance","_instance","init","localdata","localStorage","getItem","gameConfigId","startsWith","substring","decrypt","JSON","parse","setInterval","scheduleData","bind","clearConfigDataToVersion","loacalCacheVersionConfig","getConfigData","cacheVersion","loacalCacheVersionConfigArr","copyVerson","clone","cacheVersionConfig","forEach","item","index","ele","ind","versionName","version","clearConfigData","hasOwnProperty","some","el","splice","setConfigData","stringify","clearByKey","key","clear","data","value","setItem","encrypt"],"mappings":"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","sourcesContent":["import { sys } from \"cc\";\r\nimport { Constants } from \"../Constants\";\r\nimport { Util } from \"./Util\";\r\n\r\nexport class Configuration {\r\n    private _jsonData = {};\r\n    private _markSave = false;\r\n\r\n    static _instance: Configuration = null!;\r\n\r\n    public static get instance() {\r\n        if (!this._instance) {\r\n            this._instance = new Configuration();\r\n        }\r\n\r\n        return this._instance\r\n    }\r\n\r\n    /* 初始化 */\r\n    public init() {\r\n        let localdata = sys.localStorage.getItem(Constants.gameConfigId);\r\n        if (localdata && localdata.startsWith('@')) {\r\n            localdata = localdata.substring(1);\r\n            localdata = Util.decrypt(localdata);\r\n            this._jsonData = JSON.parse(localdata);\r\n        }\r\n        setInterval(this.scheduleData.bind(this), 500);\r\n    }\r\n\r\n    /* 根据版本号清除本地数据 */\r\n    public clearConfigDataToVersion() {\r\n        let loacalCacheVersionConfig = this.getConfigData(Constants.cacheVersion);\r\n        if (loacalCacheVersionConfig) {\r\n            let loacalCacheVersionConfigArr = JSON.parse(loacalCacheVersionConfig);\r\n            //比较本地版本号\r\n            let copyVerson = Util.clone(Constants.cacheVersionConfig);\r\n            Constants.cacheVersionConfig.forEach((item: any, index: number) => {\r\n                loacalCacheVersionConfigArr.forEach((ele: any, ind: number) => {\r\n                    if (item.versionName == ele.versionName && item.version > ele.version && ele.versionName == 'gameData') {\r\n                        //清除游戏数据\r\n                        this.clearConfigData();\r\n                        this._jsonData = {};\r\n                    }\r\n                    else {\r\n                        if (item.versionName == ele.versionName && item.version > ele.version) {\r\n                            if (this._jsonData.hasOwnProperty(item.versionName)) {\r\n                                delete this._jsonData[item.versionName];\r\n                            }\r\n                        }\r\n\r\n                        copyVerson.some((el, index) => {\r\n                            if (el.versionName == ele.versionName) {\r\n                                copyVerson.splice(index, 1);\r\n                                return true;\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n\r\n            //获取新增记录\r\n            copyVerson.forEach((item: any) => {\r\n                if (this._jsonData.hasOwnProperty(item.versionName)) {\r\n                    delete this._jsonData[item.versionName];\r\n                }\r\n            });\r\n\r\n        }\r\n        else {\r\n            //根据版本号清除数据\r\n            Constants.cacheVersionConfig.forEach((item: any) => {\r\n                if (this._jsonData.hasOwnProperty(item.versionName)) {\r\n                    delete this._jsonData[item.versionName];\r\n                }\r\n            })\r\n        }\r\n        //更新本地版本数据\r\n        this.setConfigData(Constants.cacheVersion, JSON.stringify(Constants.cacheVersionConfig));\r\n\r\n    }\r\n\r\n    /* 清除指定数据 */\r\n    public clearByKey(key: string) {\r\n        if (this._jsonData.hasOwnProperty(key)) {\r\n            delete this._jsonData[key];\r\n            this._markSave = true;\r\n        }\r\n    }\r\n\r\n    /* 清除存储数据 */\r\n    public clearConfigData() {\r\n        sys.localStorage.clear();\r\n    }\r\n\r\n    /* 获取存储数据 */\r\n    public getConfigData(key: string) {\r\n        const data: string = this._jsonData[key];\r\n        return data || null;\r\n    }\r\n\r\n    /* 设置存储数据 */\r\n    public setConfigData(key: string, value: string) {\r\n        this._jsonData[key] = value;\r\n        this._markSave = true;\r\n    }\r\n\r\n    /* 数据存储 */\r\n    public scheduleData() {\r\n        if (!this._markSave) {\r\n            return;\r\n        }\r\n        const data = JSON.stringify(this._jsonData);\r\n        sys.localStorage.setItem(Constants.gameConfigId, '@' + Util.encrypt(data));\r\n        this._markSave = false;\r\n    }\r\n\r\n}\r\n\r\n"]}