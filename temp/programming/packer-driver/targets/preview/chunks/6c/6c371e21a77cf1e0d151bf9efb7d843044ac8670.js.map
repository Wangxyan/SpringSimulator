{"version":3,"sources":["file:///D:/CODE/cocos_workspace/%E8%83%8C%E5%8C%85%E8%8B%B1%E9%9B%84/assets/Scripts/Game/Mgr/WeaponManager.ts"],"names":["_decorator","Component","instantiate","Intersection2D","Layout","Node","UITransform","v2","v3","GridData","ResourcesUtil","CoinObj","WeaponData","EventListener","GameEvent","Util","Constants","WeaponItem","WeaponBgItem","ccclass","property","WeaponManager","init","instance","initWeaponListPos","initWeaponList","initRemoveWeaponList","size","getGridMapSize","weaponList","setPosition","width","height","preWeaponList","itemData","getGridItemMapData","forEach","weaponObj","key","gridObjArr","data","weaponCfg","getWeaponCfgById","wid","res","Type","path","weaponPath","pos","getItemPosByTiledObj","getPrefab","then","itemPrefab","weaponItem","parent","getComponent","removeWeaponList","removeAllChildren","weaponIdData","getWeaponPool","placeId","getPlaceGridId","randIndex","Math","floor","random","length","splice","i","getUuid","itemType","weaponBgPath","updateRemoveLayOut","bagCfg","row_col","max_gridLen","split","row","Number","col","element","j","push","gridData","getGridMapData","n","m","value","getPlaceGridIdByWeigh","onRebuildWeaponPos","items","children","index","setBuildWeaponPos","showFlyGoldAnim","coinObj","wpos","convertToWorldSpaceAR","num","getRandomInt","emit","WEAPON_CHANGE_COIN","showHideRemoveList","status","active","len","layout","type","GRID","startAxis","AxisDirection","HORIZONTAL","constraint","Constraint","FIXED_COL","constraintNum","spacingX","spacingY","updateLayout","onAddRemoveWeaponList","item","onAddPreWeaponList","onWeaponPlace","gridIndexArr","curWeaponTildeIndex","includes","removeSynAction","isPlace","synKey","sanmeCount","placeIdArr","gridObj","getGridTiledByIndex","gridMapData","weaponKey","checkSameWeapoIdByKey","Id","level","Level","group","weaponGroupNum","checkWeaponByLevel","node","removeFromParent","WEAPON_UPGRADE","weaponRemove","weaponPlace","SET_BATTLE_BTN_STATUS","WEAPON_ICON_STATUS_INIT","deletGridDataByWeaponId","WEAPON_REMOVE","startPos","getPosition","startR","isSyn","itemArr","getChildByName","endPos","convertToNodeSpaceAR","endR","circleCircle","x","y","itemCom","placeStatus","setNodeAngel","addGridDataByWeaponId","onEnable","on","ADD_REMOVE_WEAPON_LIST","ADD_PRE_WEAPON_LIST","WEAPON_PlACE","WEAPON_REMOVE_REFRESH","INIT_BUILD_WEAPON_POS","onDisable","off","clear"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Intersection2D, Layout, Node, Prefab, UITransform, v2, v3 } from 'cc';\r\nimport { GridData, GridObj, WeaponObj } from '../Data/GridData';\r\nimport { ResourcesUtil } from '../../Frame/ResourcesUtil';\r\nimport { CoinObj, WeaponData } from '../Data/WeaponData';\r\nimport { EventListener } from '../../Frame/EventListener';\r\nimport { GameEvent } from '../Event/GameEvent';\r\nimport { Util } from '../../Frame/Util';\r\nimport { WeaponCfg } from '../../Model/WeaponModel';\r\nimport { Constants } from '../../Constants';\r\nimport { WeaponItem } from '../Weapon/WeaponItem';\r\nimport { WeaponBgItem } from '../Weapon/WeaponBgItem';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\nexport class WeaponManager extends Component {\r\n    @property(Node)\r\n    weaponList: Node = null;\r\n    @property(Node)\r\n    preWeaponList: Node = null;\r\n    @property(Node)\r\n    removeWeaponList: Node = null;\r\n\r\n    init() {\r\n        WeaponData.instance.init();\r\n        this.initWeaponListPos();\r\n        this.initWeaponList();\r\n        this.initRemoveWeaponList();\r\n    }\r\n\r\n    initWeaponListPos() {\r\n        let size = GridData.instance.getGridMapSize();\r\n        this.weaponList.setPosition(-size.width / 2, size.height / 2);\r\n        this.preWeaponList.setPosition(-size.width / 2, size.height / 2);\r\n    }\r\n\r\n    initWeaponList() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponObj.wid);\r\n            let res = weaponCfg.Type;\r\n            let path = Constants.weaponPath;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n            ResourcesUtil.getPrefab(path).then((itemPrefab: Prefab) => {\r\n                let weaponItem = instantiate(itemPrefab);\r\n                weaponItem.parent = this.weaponList;\r\n                weaponItem.setPosition(pos);\r\n                weaponItem.getComponent(WeaponItem).init(weaponCfg, key, true);\r\n            })\r\n        })\r\n    }\r\n\r\n    /* 初始化卸下(掉落)的武器列表 */\r\n    initRemoveWeaponList() {\r\n        //调试获取1级武器\r\n        this.removeWeaponList.removeAllChildren();\r\n        let weaponIdData: Array<number> = WeaponData.instance.getWeaponPool();\r\n        //生成格子\r\n        let placeId = this.getPlaceGridId();\r\n        if (placeId) {\r\n            let randIndex = Math.floor(Math.random() * weaponIdData.length);\r\n            weaponIdData.splice(randIndex, 1, placeId);\r\n        }\r\n        for (let i = 0; i < weaponIdData.length; i++) {\r\n            let weaponCfg = WeaponData.instance.getWeaponCfgById(weaponIdData[i]);\r\n            let key = Util.getUuid(10);\r\n            let path = weaponCfg.itemType ? Constants.weaponPath : Constants.weaponBgPath;\r\n            ResourcesUtil.getPrefab(path).then((itemPrefab: Prefab) => {\r\n                let weaponItem = instantiate(itemPrefab);\r\n                weaponItem.parent = this.removeWeaponList;\r\n\r\n                if (weaponCfg.itemType) {\r\n                    weaponItem.getComponent(WeaponItem).init(weaponCfg, key, false);\r\n                }\r\n                else {\r\n                    //格子\r\n                    weaponItem.getComponent(WeaponBgItem).init(weaponCfg, key, false);\r\n                }\r\n                this.updateRemoveLayOut();\r\n            })\r\n        }\r\n    }\r\n\r\n    /* 获取可以放置的搁置id \r\n      0：未占位 1：占位\r\n  */\r\n    getPlaceGridId() {\r\n        let bagCfg = GridData.instance.bagCfg;\r\n        let row_col = bagCfg.max_gridLen.split('_');\r\n        let row = Number(row_col[0]);\r\n        let col = Number(row_col[1]);\r\n        let data: Array<Array<number>> = [];\r\n        let placeId = 0;\r\n        for (let i = 0; i < row; i++) {\r\n            let element = [];\r\n            for (let j = 0; j < col; j++) {\r\n                element.push(1);\r\n            }\r\n            data.push(element);\r\n        }\r\n        let gridData = GridData.instance.getGridMapData();\r\n        for (let n = 0; n < gridData.length; n++) {\r\n            const element = gridData[n];\r\n            for (let m = 0; m < element.length; m++) {\r\n                const value = element[m];\r\n                if (value) {\r\n                    data[n][m] = 0;\r\n                }\r\n            }\r\n        }\r\n        placeId = WeaponData.instance.getPlaceGridIdByWeigh(data);\r\n        return placeId;\r\n    }\r\n\r\n    /* 重组武器的位置 */\r\n    onRebuildWeaponPos() {\r\n        let itemData = GridData.instance.getGridItemMapData();\r\n        itemData.forEach((weaponObj: WeaponObj, key: string) => {\r\n            let gridObjArr = weaponObj.data;\r\n            let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n            let items = this.weaponList.children;\r\n            for (let index = 0; index < items.length; index++) {\r\n                const weaponItem = items[index];\r\n                weaponItem.getComponent(WeaponItem).setBuildWeaponPos(key, pos);\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n    /* 转换飞的金币动画 */\r\n    showFlyGoldAnim() {\r\n        if (this.removeWeaponList.children.length) {\r\n            let items = this.removeWeaponList.children;\r\n            for (let i = 0; i < items.length; i++) {\r\n                const element = items[i];\r\n                let coinObj = new CoinObj();\r\n                coinObj.wpos = element.getComponent(UITransform).convertToWorldSpaceAR(v3(0, 0, 0));\r\n                coinObj.num = Util.getRandomInt(5, 10);\r\n                EventListener.emit(GameEvent.WEAPON_CHANGE_COIN, coinObj);\r\n            }\r\n        }\r\n    }\r\n\r\n    /* 隐藏显示卸载列表 */\r\n    showHideRemoveList(status: boolean) {\r\n        this.removeWeaponList.active = status;\r\n    }\r\n\r\n    /* 根据内容设置排布 */\r\n    //updateRemoveLayOut() {\r\n    //    let len = this.removeWeaponList.children.length;\r\n    //    let diff = (len - 3) > 0 ? len - 3 : 0;\r\n    //    let spaceX = 0 - diff * 10;\r\n    //    this.removeWeaponList.getComponent(Layout).spacingX = spaceX;\r\n    //    this.removeWeaponList.getComponent(Layout).updateLayout(true);\r\n    //}\r\n\r\n    updateRemoveLayOut() {\r\n        let len = this.removeWeaponList.children.length;\r\n        let layout = this.removeWeaponList.getComponent(Layout);\r\n\r\n        // 设置为网格布局  \r\n        layout.type = Layout.Type.GRID;\r\n        layout.startAxis = Layout.AxisDirection.HORIZONTAL;\r\n        layout.constraint = Layout.Constraint.FIXED_COL;\r\n        layout.constraintNum = 2; // 2列  \r\n\r\n        // 设置间距  \r\n        layout.spacingX = 50;\r\n        layout.spacingY = 50;\r\n\r\n        layout.updateLayout(true);\r\n    }\r\n\r\n    /* 添加到卸下武器列表 */\r\n    onAddRemoveWeaponList(item: Node) {\r\n        item.parent = this.removeWeaponList;\r\n        this.updateRemoveLayOut();\r\n    }\r\n\r\n    /* 添加到临时武器列表 */\r\n    onAddPreWeaponList(item: Node) {\r\n        item.parent = this.preWeaponList;\r\n    }\r\n\r\n    /* 武器放置完成 */\r\n    onWeaponPlace(weaponItem: WeaponItem) {\r\n        let gridIndexArr = GridData.instance.curWeaponTildeIndex;\r\n        //1.放置 2.替换 3.卸下\r\n        if (gridIndexArr.includes(-1)) {\r\n            //卸下(外合成)\r\n            this.removeSynAction(weaponItem);\r\n        }\r\n        else {\r\n            let isPlace = false; //是否替换和合成\r\n            let synKey = '';//被合成的装备key\r\n            let sanmeCount = 0;//相同wid 数量\r\n            let placeIdArr = []; //替换的武器唯一id(可能多个)\r\n            let gridObjArr: Array<GridObj> = [];\r\n            for (let i = 0; i < gridIndexArr.length; i++) {\r\n                const index = gridIndexArr[i];\r\n                let gridObj = GridData.instance.getGridTiledByIndex(index);\r\n                let gridMapData = GridData.instance.getGridMapData();\r\n                gridObjArr.push(gridObj);\r\n                if (gridMapData[gridObj.row][gridObj.col]) {\r\n                    //占用(替换)\r\n                    if (!isPlace) {\r\n                        isPlace = true;\r\n                    }\r\n                    let weaponKey = gridMapData[gridObj.row][gridObj.col];\r\n                    placeIdArr.push(weaponKey);\r\n                    //检测武器id、等级是否相同\r\n                    if (GridData.instance.checkSameWeapoIdByKey(weaponKey, weaponItem.weaponCfg.Id)) {\r\n                        sanmeCount++;\r\n                        synKey = weaponKey;\r\n                    }\r\n                }\r\n            }\r\n            if (isPlace) {\r\n                //替换或合成(卸下 + 放置)\r\n                //是否有可以合成的下一级别\r\n                let level = weaponItem.weaponCfg.Level;\r\n                let group = weaponItem.weaponCfg.weaponGroupNum;\r\n                if (sanmeCount == gridIndexArr.length && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                    weaponItem.node.removeFromParent();\r\n                    //合成(内合成)\r\n                    EventListener.emit(GameEvent.WEAPON_UPGRADE, synKey, true);\r\n                }\r\n                else {\r\n                    //卸下\r\n                    this.weaponRemove(placeIdArr);\r\n                    //放置\r\n                    this.weaponPlace(weaponItem, gridObjArr);\r\n                }\r\n\r\n            }\r\n            else {\r\n                //没占用直接放置\r\n                this.weaponPlace(weaponItem, gridObjArr);\r\n            }\r\n        }\r\n        //设置战斗按钮状态\r\n        EventListener.emit(GameEvent.SET_BATTLE_BTN_STATUS);\r\n        //初始状态\r\n        EventListener.emit(GameEvent.WEAPON_ICON_STATUS_INIT);\r\n    }\r\n\r\n    /* 卸下 */\r\n    weaponRemove(placeIdArr: Array<string>) {\r\n        for (let i = 0; i < placeIdArr.length; i++) {\r\n            const weaponKey = placeIdArr[i];\r\n            GridData.instance.deletGridDataByWeaponId(weaponKey);\r\n            EventListener.emit(GameEvent.WEAPON_REMOVE, weaponKey);\r\n        }\r\n    }\r\n\r\n    /* 卸下合成 */\r\n    removeSynAction(weaponItem: WeaponItem) {\r\n        let startPos = weaponItem.node.getPosition();\r\n        let startR = 100;\r\n        let isSyn: boolean = false;\r\n        let synKey = '';//被合成的装备key\r\n        //检测是否可以外合成\r\n        let itemArr = this.removeWeaponList.children;\r\n        for (let i = 0; i < itemArr.length; i++) {\r\n            const item = itemArr[i];\r\n            if (item.getComponent(WeaponItem)) {\r\n                //是否未武器  非格子\r\n                let wpos = item.getChildByName('icon').getComponent(UITransform).convertToWorldSpaceAR(v3(0, 0, 0));\r\n                let endPos = this.preWeaponList.getComponent(UITransform).convertToNodeSpaceAR(wpos);\r\n                let endR = 100;\r\n                if (Intersection2D.circleCircle(v2(startPos.x, startPos.y), startR, v2(endPos.x, endPos.y), endR)) {\r\n                    let itemCom = item.getComponent(WeaponItem);\r\n                    //是否可以合成 相同等级  有可以合成的下一级\r\n                    let level = weaponItem.weaponCfg.Level;\r\n                    let group = weaponItem.weaponCfg.weaponGroupNum;\r\n                    if (weaponItem.weaponCfg.Id == itemCom.weaponCfg.Id && WeaponData.instance.checkWeaponByLevel(level + 1, group)) {\r\n                        isSyn = true;\r\n                        synKey = itemCom.weaponKey;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (isSyn) {\r\n            weaponItem.node.removeFromParent();\r\n            //合成(外合成)\r\n            EventListener.emit(GameEvent.WEAPON_UPGRADE, synKey, false);\r\n        }\r\n        else {\r\n            weaponItem.node.parent = this.removeWeaponList;\r\n            weaponItem.placeStatus = false;\r\n            weaponItem.setNodeAngel();\r\n            this.updateRemoveLayOut();\r\n        }\r\n    }\r\n\r\n    /* 放置 */\r\n    weaponPlace(weaponItem: WeaponItem, gridObjArr: Array<GridObj>) {\r\n        weaponItem.node.parent = this.weaponList;\r\n        GridData.instance.addGridDataByWeaponId(gridObjArr, weaponItem.weaponCfg.Id, weaponItem.weaponKey);\r\n        let pos = GridData.instance.getItemPosByTiledObj(gridObjArr);\r\n        weaponItem.node.setPosition(pos);\r\n        weaponItem.placeStatus = true;\r\n        weaponItem.setNodeAngel();\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        EventListener.on(GameEvent.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        EventListener.on(GameEvent.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        EventListener.on(GameEvent.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        EventListener.on(GameEvent.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        EventListener.on(GameEvent.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        EventListener.off(GameEvent.ADD_REMOVE_WEAPON_LIST, this.onAddRemoveWeaponList, this);\r\n        EventListener.off(GameEvent.ADD_PRE_WEAPON_LIST, this.onAddPreWeaponList, this);\r\n        EventListener.off(GameEvent.WEAPON_PlACE, this.onWeaponPlace, this);\r\n        EventListener.off(GameEvent.WEAPON_REMOVE_REFRESH, this.initRemoveWeaponList, this);\r\n        EventListener.off(GameEvent.INIT_BUILD_WEAPON_POS, this.onRebuildWeaponPos, this);\r\n\r\n    }\r\n\r\n    clear() {\r\n        WeaponData.instance.clear();\r\n    }\r\n}\r\n\r\n\r\n"]}